// ... بخش قبلی کدهای HTML و CSS (بدون تغییر) ...

    <script src="https://cdn.jsdelivr.net/npm/tsparticles-confetti@2.12.0/tsparticles.confetti.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // =================================================================
            //                 🔑 دیتاسورس‌ها و متغیرهای کلیدی 🔑
            // =================================================================

            const sections = document.querySelectorAll('.full-screen');
            const backgroundMusic = document.getElementById('background-music');
            
            // Endpoint شما برای چک کردن وضعیت (GET) و ذخیره‌ی نهایی (POST)
            const WEBHOOK_ENDPOINT = "https://n8n.ipdev.ir/webhook/fa917e63-86c3-481b-8c14-b8586e4f31bb";
            
            // لیست ثابت کاربران مجاز (دیتای اولیه شما)
            const AUTH_LIST = {
                '09198967708': { name: 'ماهان چگینی', dept: 'مالی' }, 
                '09121234567': { name: 'سارا احمدی', dept: 'فنی' },
                '09359876543': { name: 'مریم عظیمی', dept: 'عملیات' },
                '09015554433': { name: 'نیلوفر رضایی', dept: 'مارکتینگ' },
                // ... بقیه کاربران مجاز
            };

            const TEST_OTP = '1111';
            let currentUser = {}; 
            
            const GIFTS = [
                "300,000 تومان اعتبار خرید از کافه شرکت",
                "کدتخفیف 100% (یک آیتم) خرید از کافه",
                "بلیت استخر سه‌ماهه‌ رایگان",
                "بن تخفیف 200,000 تومانی اسنپ‌فود"
            ];
            
            // --- توابع کمکی (ناوبری و کانفتی و کپی‌رایتینگ) ---
            const navigateTo = (targetId) => {
                const targetSection = document.getElementById(targetId);
                sections.forEach(sec => { sec.classList.remove('active-section'); });
                targetSection.classList.add('active-section');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
            const runConfetti = () => { /* ... */ }; 
            const DEPT_MESSAGES = { /* ... */ };
            const PERSONALIZED_TEXT = { /* ... */ };
            
            // =================================================================
            //                 ✅ تابع ثبت نهایی و ناوبری (POST Webhook) ✅
            // =================================================================
            // این تابع بعد از وارد کردن OTP کال می‌شود.
            const registerUserAndProceed = async (button, errorElement) => {
                const phone = document.getElementById('phone-input').value.trim();
                const mobileNumberOnly = phone.replace(/[^0-9]/g, ''); 
                
                const payload = {
                    mobile: mobileNumberOnly,
                    name: currentUser.name,
                    dept: currentUser.dept,
                    status: 'VERIFIED_OTP', // وضعیت پس از تأیید کد
                };

                try {
                    // ارسال درخواست POST برای ثبت کاربر پس از تأیید OTP
                    const response = await fetch(WEBHOOK_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        // اگر سرور خطا داد
                        throw new Error(`Server responded with status: ${response.status}`);
                    }
                    
                    // اگر ثبت نام موفق بود، ادامه می‌دهیم
                    const firstName = currentUser.name.split(' ')[0];
                    const textData = PERSONALIZED_TEXT[firstName] || PERSONALIZED_TEXT['default'];
                    document.getElementById('portal-title').textContent = textData.portal_title;
                    document.getElementById('portal-challenge-text').textContent = textData.portal_challenge;

                    button.textContent = 'ورود به پرتال';
                    button.disabled = false;
                    navigateTo('portal-section');
                    
                    // شبیه‌سازی لودینگ 3 ثانیه‌ای و ناوبری خودکار
                    setTimeout(() => {
                        const giftTitleText = textData.gift_reveal_title(firstName);
                        document.getElementById('gift-reveal-title').textContent = giftTitleText;
                        
                        document.getElementById('jewel-box').style.display = 'block';
                        document.getElementById('reveal-message').textContent = 'این جعبه‌ی جادویی فقط با یک کلیک تو باز می‌شود...';
                        document.getElementById('show-gift-btn').style.display = 'block'; 
                        
                        navigateTo('gift-reveal-section'); 
                    }, 3000); 

                } catch (e) {
                    console.error("Registration Webhook Error:", e);
                    errorElement.textContent = "مشکلی در اتصال به سرور برای ثبت نهایی پیش آمد. دوباره تلاش کنید. 😢";
                    button.textContent = 'ورود به پرتال';
                    button.disabled = false;
                }
            };

            // --- Logic: Hero Section (پخش موزیک) ---
            document.getElementById('start-adventure-btn').addEventListener('click', () => {
                backgroundMusic.volume = 0.5;
                backgroundMusic.play().catch(error => { console.log('Autoplay blocked.'); });
                navigateTo('phone-section');
            });

            // --- Logic: Phone Verification (GET Webhook) ---
            document.getElementById('verify-phone-btn').addEventListener('click', async () => {
                const phoneInput = document.getElementById('phone-input').value.trim();
                const errorText = document.getElementById('phone-error');
                errorText.textContent = '';
                
                const verifyButton = document.getElementById('verify-phone-btn');
                verifyButton.disabled = true;
                verifyButton.textContent = 'درحال بررسی...';

                // 1. احراز هویت اولیه: چک کردن لیست ثابت AUTH_LIST (اولویت اول)
                if (!AUTH_LIST[phoneInput]) {
                    errorText.textContent = "شماره وارد شده در لیست مهمان‌های جشن امروز نیست. لطفا دوباره چک کن. 😔";
                    verifyButton.textContent = 'تأیید هویت';
                    verifyButton.disabled = false;
                    return;
                }
                
                // --- اگر در لیست اولیه بود، حالا وضعیت تکراری را از سرور چک می‌کنیم ---
                const mobileNumberOnly = phoneInput.replace(/[^0-9]/g, ''); 
                const url = `${WEBHOOK_ENDPOINT}?mobile=${mobileNumberOnly}`;

                try {
                    const response = await fetch(url);
                    const result = await response.text(); 
                    const status = result.trim().toLowerCase();

                    if (status === 'duplicate') {
                        // 2. شماره تکراری است
                        errorText.textContent = "عزیزم! شما قبلاً گنجینه‌ی روز دخترت رو باز کردی! ✨";
                        verifyButton.textContent = 'تأیید هویت';
                        verifyButton.disabled = false;
                        return;

                    } else if (status === 'new') {
                        
                        // 3. شماره جدید است، به مرحله OTP می‌رود
                        currentUser = AUTH_LIST[phoneInput];
                        const firstName = currentUser.name.split(' ')[0];
                        const textData = PERSONALIZED_TEXT[firstName] || PERSONALIZED_TEXT['default'];
                        document.getElementById('otp-welcome-text').textContent = textData.otp_welcome(firstName);

                        verifyButton.textContent = 'تأیید هویت';
                        verifyButton.disabled = false;
                        navigateTo('otp-section');

                    } else {
                        // 4. خطای پاسخ نامعتبر (فقط اگر سرور پاسخ داد ولی محتوای نامعتبر بود)
                        errorText.textContent = "خطای سرور: پاسخ نامعتبر دریافت شد. 😥";
                        verifyButton.textContent = 'تأیید هویت';
                        verifyButton.disabled = false;
                    }

                } catch (e) {
                    // 5. خطای اتصال واقعی (Timeout, CORS, Network Error)
                    console.error("API Error (Connection failed):", e);
                    errorText.textContent = "مشکلی در اتصال به سرور پیش آمد. لطفا دوباره امتحان کنید. 😥";
                    verifyButton.textContent = 'تأیید هویت';
                    verifyButton.disabled = false;
                }
            });

            // --- Logic: OTP Verification (کال registerUserAndProceed) ---
            document.getElementById('verify-otp-btn').addEventListener('click', () => {
                const otpInput = document.getElementById('otp-input').value.trim();
                const errorText = document.getElementById('otp-error');
                const verifyButton = document.getElementById('verify-otp-btn');

                if (otpInput === TEST_OTP) {
                    errorText.textContent = '';
                    verifyButton.disabled = true;
                    verifyButton.textContent = 'درحال ثبت نهایی...';

                    // Webhook POST برای ثبت در شیت
                    registerUserAndProceed(verifyButton, errorText);

                } else {
                    errorText.textContent = "کد درست نیست! لطفاً با دقت چک کن، پرتال آرزوها منتظره! 🎁";
                }
            });

            // --- Logic: One-Click Gift Reveal (ذخیره‌سازی نهایی CLAIMED) ---
            const giftPopup = document.getElementById('gift-popup');

            document.getElementById('show-gift-btn').addEventListener('click', async () => {
                
                document.getElementById('jewel-box').style.display = 'none';
                document.getElementById('reveal-message').textContent = '🎉 باز شد! 🎉';
                document.getElementById('show-gift-btn').style.display = 'none'; 

                const randomGift = GIFTS[Math.floor(Math.random() * GIFTS.length)];
                document.getElementById('gift-amount').textContent = randomGift;
                
                const firstName = currentUser.name.split(' ')[0];
                const messageFunc = DEPT_MESSAGES[currentUser.dept] || DEPT_MESSAGES['default'];
                document.getElementById('personal-message').textContent = messageFunc(firstName);

                document.getElementById('popup-gift-title').textContent = `🥳 هدیه و سورپرایز ویژه ${firstName} عزیز: 🥳`;
                
                // ذخیره‌ی نهایی وضعیت در سرور با POST (تغییر وضعیت به CLAIMED)
                const phone = document.getElementById('phone-input').value.trim();
                const mobileNumberOnly = phone.replace(/[^0-9]/g, ''); 

                const payload = {
                    mobile: mobileNumberOnly,
                    name: currentUser.name,
                    gift_amount: randomGift,
                    status: 'CLAIMED' // وضعیت نهایی
                };

                try {
                    await fetch(WEBHOOK_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    });
                    console.log('Gift claim successfully posted to server.');
                } catch (e) {
                    console.error('Error posting final gift claim:', e);
                }

                giftPopup.style.display = 'flex';
                runConfetti();
            });

            // --- بقیه منطق‌ها ---
            document.querySelectorAll('.close-btn, #popup-next-btn').forEach(el => {
                el.addEventListener('click', () => {
                    giftPopup.style.display = 'none';
                    navigateTo('friend-section');
                });
            });

            document.getElementById('friend-message-form').addEventListener('submit', (e) => {
                e.preventDefault();
                // ...
            });

            // --- Initial Setup ---
            navigateTo('hero-section'); 
        });
    </script>
</body>
</html>
